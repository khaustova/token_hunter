{% extends "admin/base_site.html" %}
{% load i18n static dashboard_tags %}
{% get_customization_settings as customization %}

{% block title %}{{ customization.title }}{% endblock %}

{% block extrahead %}
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css">
<script src="{% static 'django_select2/django_select2.js' %}"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
<script src="{% static "dashboard/js/transaction_chart.js" %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script> 
{% endblock %}

{% block content %}
  {% get_apps as apps %}
  {% if apps %}
    {% widthratio apps|length 2 1 as middle %}
  {% endif %}
  <div class="content_wrapper">
    <div class="content-apps">
      {% block content-apps %}

      <div class="content-card">
        <h4 class="content-card__title">{% get_settings_form %}</h4>
        <form class="parsing__form" action="{% url 'token_hunter:monitor_dexscreener' %}" method="POST">
          {% csrf_token %}
          <div class="settings_wrapper">
          {% for field in settings_form %}
            {{ field.label_tag }}
            {{ field }}
            {% if field.errors %}
              <div class="error">{{ field.errors }}</div>
            {% endif %}
          {% endfor %}
          </div>
            
          <div class="parsing-buttons_wrapper">
              <button class="watcher__button" id="watch-dex-button" type="submit" name="_monitoring">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Dexscreener üëÄ</button>
              <button class="watcher__button" id="watch-dex-button" type="submit" name="_parsing">–û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ø –∫–æ—à–µ–ª—å–∫–æ–≤ üìà</button>

            {% get_celery_tasks_id as celery_tasks_id %}
            <p>
              <b>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–æ–≤:</b>
              {% if celery_tasks_id.track_tokens_task_id %} 
              ‚úÖ (<a class="stop_task_link" href="{% url 'token_hunter:stop_task' task_id=celery_tasks_id.track_tokens_task_id.0 %}">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</a>)
              {% else %}
              ‚ùå (<a href="{% url 'token_hunter:start_track_tokens_task' %}">–ó–∞–ø—É—Å—Ç–∏—Ç—å</a>)
              {% endif %}
            </p>

            {% if celery_tasks_id.boosted_task_id %}
              <p class="loading"><b>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ boosted —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ Dexscreener</b></p>
              {% for boosted_id in celery_tasks_id.boosted_task_id %}
                <p class="stop_task">
                  <a class="stop_task_link" href="{% url 'token_hunter:stop_task' task_id=boosted_id %}">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä {{ boosted_id|truncatechars:5 }}</a>
                </p>
              {% endfor %}
            {% endif %}

            {% if celery_tasks_id.filter_task_id %}
            <p class="loading"><b>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ Dexscreener –ø–æ —Ñ–∏–ª—å—Ç—Ä—É</b></p>
            {% for filter_task_id in celery_tasks_id.filter_task_id %}
              <p class="stop_task">
                <a class="stop_task_link" href="{% url 'token_hunter:stop_task' task_id=filter_task_id %}">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä {{ filter_task_id|truncatechars:5 }}</a>
              </p>
            {% endfor %}
          {% endif %}

          {% if celery_tasks_id.parsing_task_id %}
          <p class="loading"><b>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–∞—Ä—Å–∏–Ω–≥ —Ç–æ–ø–∞ –∫–æ—à–µ–ª—å–∫–æ–≤ –Ω–∞ Dexscreener –ø–æ —Ñ–∏–ª—å—Ç—Ä—É</b></p>
          {% for parsing_task_id in celery_tasks_id.parsing_task_id %}
            <p class="stop_task">
              <a class="stop_task_link" href="{% url 'token_hunter:stop_task' task_id=parsing_task_id %}">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä {{ parsing_task_id|truncatechars:5 }}</a>
            </p>
          {% endfor %}
        {% endif %}

          </div>
        </form>
      </div>

      <div class="content-card">
        <h4 class="content-card__title">{% get_check_token_form %}</h4>
          {% csrf_token %}
          {% for field in check_token_form %}
            {{field.label_tag}}
            <div class="check-token__form">
            {{field}}
            {% if field.errors%}
              <div class="error">{{field.errors}}</div>
            {% endif %}
          {% endfor %}
          <button class="check-token__button" id="check-token-button" type="submit" name='checktokenButton'>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω üîé</button>
          <div id="check-token-result"></div>
        </div>
      </div>

      <div class="content-card">
        <table class="table">
          <caption>
            <h4 class="table__title">{% get_top_traders %}</h4>
          </caption>
          <tbody>
            <th>–ö–æ—à–µ–ª—ë–∫</th>
            <th>–£—Å–ø–µ—à–Ω—ã–µ —Å–¥–µ–ª–∫–∏</th>
            {% for trader in top_traders %}
              <tr>
                <td>
                  {% get_wallet_link trader.wallet_address as solsniffer_link %}
                  <a href="{{ solsniffer_link }}">{{ trader.wallet_address }}</a>
                </td>
                <td>
                  {{ trader.token_count }}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="paginator">
          <div class="table__pagination-pages">
            {% if top_traders.has_previous %}
              <a href="?page={{ top_traders.previous_page_number }}">–ù–∞–∑–∞–¥</a>
              {% if top_traders.number > 3 %}
                <a href="?page=1">1</a>
                {% if top_traders.number > 4 %}
                  ...
                {% endif %}
              {% endif %}
            {% endif %}
            {% for num in top_traders.paginator.page_range %}
              {% if top_traders.number == num %}
                {{ num }}
              {% elif num > top_traders.number|add:'-3' and num < top_traders.number|add:'3' %}
                <a href="?page={{ num }}">{{ num }}</a>
              {% endif %}
            {% endfor %}
            {% if top_traders.has_next %}
              {% if top_traders.number < top_traders.paginator.num_pages|add:'-3' %}
                <a >...</a>
                <a href="?page={{ top_traders.paginator.num_pages }}">
                  {{ top_traders.paginator.num_pages }}
                </a>
              {% elif top_traders.number < top_traders.paginator.num_pages|add:'-2' %}
                <a href="?page={{ top_traders.paginator.num_pages }}">
                  {{ top_traders.paginator.num_pages }}
                </a>
              {% endif %}
              <a href="?page={{ top_traders.next_page_number }}">–î–∞–ª–µ–µ</a>
            {% endif %}
          </div>
        </div>
      </div>
      {% endblock %}
    </div>
    
    <div class="content-other">

      <div class="content-card">
        <h4 class="content-card__title">–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏</h4>
          <div>
            {% get_open_transactions as open_transactions %}
            {% if open_transactions %}
            <table class="table">
              <tbody>
                <th>–¢–æ–∫–µ–Ω</th>
                <th>–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</th>
                <th>–¢–µ–∫—É—â–∏–π PNL</th>
                {% for pair, data in open_transactions.items %}
                  <tr>
                    <td>
                      <a href="https://dexscreener.com/solana/{{ pair }}">{{ data.token_name }}</a>
                    </td>
                    <td>
                      {{ data.opening_date }}
                    </td>
                    <td>
                      {{ data.current_pnl }} %
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>

            {% else %}
             –û—Ç–∫—Ä—ã—Ç—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–µ—Ç
            {% endif %}
          </div>
      </div>

      <div class="content-card">
        <h4 class="content-card__title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>

        <div class="tabs views"> 
          <input class="pnl__input" id="pnlRealTab" type="radio" name="pnl" checked> 
          <label class="pnl__label" for="pnlRealTab">–†–µ–∞–ª—å–Ω–∞—è –ø–æ–∫—É–ø–∫–∞</label> 
          <input class="pnl__input" id="pnlEmulationTab" type="radio" name="pnl"> 
          <label class="pnl__label" for="pnlEmulationTab">–≠–º—É–ª—è—Ü–∏—è</label> 
          <input class="pnl__input" id="pnlCollectionTab" type="radio" name="pnl"> 
          <label class="pnl__label" for="pnlCollectionTab">–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö</label>
          <input class="pnl__input" id="pnlBoostedTab" type="radio" name="pnl"> 
          <label class="pnl__label" for="pnlBoostedTab">Boosted</label> 
          <section class="pnl__section" id="pnlRealContent"> 
            <div class="pnl__pie">
              <canvas id="realPNL"></canvas>
            </div>
          </section>   
          <section class="pnl__section" id="pnlEmulationContent"> 
            <div class="pnl__pie">
              <canvas id="emulationPNL"></canvas>
            </div>
          </section>
          <section class="pnl__section" id="pnlCollectionContent"> 
            <div class="pnl__pie">
              <canvas id="dataCollectionPNL"></canvas>
            </div>
          </section> 
          <section class="pnl__section" id="pnlBoostedContent"> 
            <div class="pnl__pie">
              <canvas id="boostedPNL"></canvas>
            </div>
          </section> 
        </div> 
      </div>
    </div>
  </div>

  <script>
    document.getElementById("check-token-button").addEventListener("click", function(event) {
      event.preventDefault();
      const token = document.getElementById('check-token-input').value;
      const url = "{% url 'token_hunter:check_token' %}"
      fetch(url, {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}"
          },
          body: JSON.stringify(token)
        })
        .then(response => response.json())
        .then(data => {
          document.getElementById("check-token-result").innerText = `hello`;
      })
    });
  </script>
{% endblock %}
